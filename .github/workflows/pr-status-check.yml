name: PR Status Dashboard

permissions:
  contents: read
  issues: write

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday at 9 AM UTC
  workflow_dispatch:

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Dependabot PRs
        run: |
          echo "## ðŸ“Š Dependabot PRs Status Report"
          echo "Generated: $(date)"
          echo ""
          
          echo "### Open PRs from Dependabot:"
          if ! gh pr list --author "app/dependabot" --json number,title,labels,createdAt \
            --jq '.[] | "- PR #\(.number): \(.title) - Labels: \(.labels[].name // "none") - Created: \(.createdAt)"'; then
            echo "Error: Failed to fetch Dependabot PRs" >&2
            exit 1
          fi
          
          echo ""
          echo "### PRs needing review:"
          if ! gh pr list --label "needs-review" --json number,title,author \
            --jq '.[] | "- PR #\(.number): \(.title) by \(.author.login)"'; then
            echo "Error: Failed to fetch PRs needing review" >&2
            exit 1
          fi
          
          echo ""
          echo "### Auto-merge enabled PRs:"
          if ! gh pr list --label "auto-merge" --json number,title,mergeable \
            --jq '.[] | "- PR #\(.number): \(.title) - Mergeable: \(.mergeable)"'; then
            echo "Error: Failed to fetch auto-merge PRs" >&2
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue if needed
        run: |
          NEEDS_REVIEW_COUNT=$(gh pr list --label "needs-review" --json number --jq '. | length')
          
          if [ "$NEEDS_REVIEW_COUNT" -gt 0 ]; then
            if ! gh issue create \
              --title "âš ï¸ $NEEDS_REVIEW_COUNT PRs need manual review" \
              --body "There are $NEEDS_REVIEW_COUNT pull requests waiting for manual review. Please check PRs with the 'needs-review' label." \
              --label "maintenance"; then
              # Check if it failed due to duplicate
              if gh issue list --label "maintenance" --search "PRs need manual review" --json number --jq '. | length' | grep -q "^[1-9]"; then
                echo "Issue already exists, skipping creation"
              else
                echo "Error: Failed to create issue" >&2
                exit 1
              fi
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
