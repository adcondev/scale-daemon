# https://taskfile.dev
# Scale Daemon - Task Runner para Dev & Testing
# Dev: AdriÃ¡n Constante @ Red2000 2025
#
# USO RÃPIDO:
#   task              - Ver todas las tareas disponibles
#   task dev          - Setup completo para desarrollo
#   task test         - Correr todos los tests
#   task build: test   - Compilar versiÃ³n de pruebas
#
version: '3'

# usar silent: false para debug
silent: true

# =============================================================================
# VARIABLES GLOBALES
# =============================================================================
vars:
  # Nombres de componentes
  SERVICE_NAME: BasculaServicio
  INSTALLER_NAME: BasculaInstalador

  # Rutas
  SERVICE_PATH: ./cmd/{{.SERVICE_NAME}}/service.go
  INSTALLER_PATH: ./cmd/{{.INSTALLER_NAME}}/installer.go
  BIN_DIR: ./bin
  LOGS_DIR: '{{.PROGRAMDATA | default "/tmp"}}/{{.SERVICE_NAME}}'

  # Build info (inyectado en tiempo de compilaciÃ³n)
  BUILD_ENV: '{{.BUILD_ENV | default "test"}}'
  BUILD_DATE: '{{now | date "2006-01-02"}}'
  BUILD_TIME: '{{now | date "15:04:05"}}'
  VERSION: '1.1.0'

  # Build tags segÃºn ambiente
  TEST_BUILD_TAG: test_build
  PROD_BUILD_TAG: prod_build

  # Colores para output (ANSI)
  GREEN: '\033[0;32m'
  YELLOW: '\033[0;33m'
  RED: '\033[0;31m'
  BLUE: '\033[0;34m'
  NC: '\033[0m'

# =============================================================================
# VARIABLES DE ENTORNO
# =============================================================================
env:
  # Go
  CGO_ENABLED: '0'
  GOOS: windows
  GOARCH: amd64

  # Testing
  RUN_INTEGRATION_TESTS: '{{.RUN_INTEGRATION_TESTS | default "1"}}'

# =============================================================================
# TAREA DEFAULT - MOSTRAR AYUDA
# =============================================================================
tasks:
  default:
    desc: "ğŸ“‹ Mostrar todas las tareas disponibles"
    silent: true
    cmds:
      - |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           SCALE DAEMON - Task Runner v{{.VERSION}}              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸš€ INICIO RÃPIDO:"
        echo "   task dev          Configurar entorno de desarrollo"
        echo "   task build:test   Compilar versiÃ³n TEST"
        echo "   task test         Ejecutar todos los tests"
        echo ""
      - task --list-all

  # ===========================================================================
  # ğŸ”§ SETUP & DEPENDENCIES
  # ===========================================================================
  deps:
    desc: "ğŸ“¦ Descargar e instalar dependencias de Go"
    cmds:
      - echo "ğŸ“¦ Descargando dependencias..."
      - go mod download
      - go mod tidy
      - go mod verify
      - echo "âœ… Dependencias instaladas"

  deps:tools:
    desc: "ğŸ› ï¸ Instalar herramientas de desarrollo (golangci-lint, etc)"
    cmds:
      - echo "ğŸ› ï¸ Instalando herramientas..."
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install golang.org/x/tools/cmd/goimports@latest
      - echo "âœ… Herramientas instaladas"

  dev:
    desc: "ğŸš€ Setup completo para desarrollo (deps + build test)"
    cmds:
      - task: deps
      - task: build:test
      - echo ""
      - echo "âœ… Entorno de desarrollo listo!"
      - echo ""
      - echo "PrÃ³ximos pasos:"
      - echo "  1. task install:test    - Instalar servicio de prueba"
      - echo "  2. task run:installer   - Ejecutar el instalador TUI"
      - echo "  3. task test            - Correr tests"

  # ===========================================================================
  # ğŸ—ï¸ BUILD
  # ===========================================================================
  service:build:
    desc: "ğŸ”¨ Compilar servicio Windows"
    vars:
      BUILD_ENV: '{{.BUILD_ENV | default "prod"}}'
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - mkdir -p embedded/bin
      - go build -ldflags "-s -w -H=windowsgui -X main.BuildEnvironment={{.BUILD_ENV}} -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o embedded/bin/BasculaServicio.exe ./cmd/BasculaServicio
      - echo "âœ… Servicio compilado embedded/bin/BasculaServicio.exe ({{.BUILD_ENV}})"
    generates:
      - embedded/bin/BasculaServicio.exe

  installer:build:
    desc: "ğŸ”¨ Compilar instalador TUI con servicio embebido"
    vars:
      BUILD_ENV: '{{.BUILD_ENV | default "prod"}}'
      BUILD_TAG: '{{if eq .BUILD_ENV "test"}}test_build{{else}}prod_build{{end}}'
      OUT_FILE: 'bin/{{.INSTALLER_NAME}}_{{.BUILD_ENV}}.exe'
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - task: service:build
        vars:
          BUILD_ENV: '{{.BUILD_ENV}}'
      - mkdir -p bin
      - go build -tags {{.BUILD_TAG}} -ldflags "-s -w -X main.BuildEnvironment={{.BUILD_ENV}} -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o {{.OUT_FILE}} ./cmd/BasculaInstalador
      - echo "âœ… Instalador compilado {{.OUT_FILE}} ({{.BUILD_ENV}}) con tag {{.BUILD_TAG}}"
    sources:
      - ./cmd/BasculaInstalador/**/*.go
      - embedded/bin/BasculaServicio.exe
    generates:
      - '{{.OUT_FILE}}'

  build:test:
    desc: "ğŸ§ª Compilar TODO para TEST (localhost: 8765)"
    cmds:
      - task: installer:build
        vars: { BUILD_ENV: test }
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘   âœ… BUILD TEST COMPLETADO                â•‘"
      - echo "â•‘  â¡ï¸ ./bin/{{.INSTALLER_NAME}}_test.exe      â•‘"
      - echo "â•‘  â¡ï¸ Escucha en:localhost:8765             â•‘"
      - echo "â•‘  â¡ï¸ Build tag:test_build                  â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  build:prod:
    desc: "ğŸš€ Compilar TODO para PRODUCCIÃ“N (0.0.0.0:8765)"
    cmds:
      - task: installer:build
        vars: { BUILD_ENV: prod }
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘   âœ… BUILD PROD COMPLETADO               â•‘"
      - echo "â•‘  â¡ï¸ ./bin/{{.INSTALLER_NAME}}_prod.exe     â•‘"
      - echo "â•‘  â¡ï¸ Escucha en:0.0.0.0:8765              â•‘"
      - echo "â•‘  â¡ï¸ Build tag:prod_build                 â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  build:all:
    desc: "ğŸ—ï¸ Compilar ambos ambientes (test + prod)"
    cmds:
      - task: build:test
      - task: build:prod
      - echo ""
      - echo "âœ… Ambos builds completados!"
      - ls -la {{.BIN_DIR}}/*.exe

  # ===========================================================================
  # ğŸ§ª TESTING
  # ===========================================================================
  test:
    desc: "ğŸ§ª Ejecutar TODOS los tests (unit + integration si RUN_INTEGRATION_TESTS=1)"
    cmds:
      - echo "ğŸ§ª Ejecutando tests con tag test_build..."
      - go test -tags test_build -v -cover ./...
    env:
      RUN_INTEGRATION_TESTS: '{{.RUN_INTEGRATION_TESTS | default "0"}}'

  test:unit:
    desc: "ğŸ§ª Ejecutar solo tests unitarios (rÃ¡pido)"
    cmds:
      - echo "ğŸ§ª Tests unitarios con tag test_build..."
      - go test -tags test_build -v -short ./...

  test:integration:
    desc: "ğŸ”Œ Ejecutar tests de integraciÃ³n (requiere servicio corriendo)"
    cmds:
      - echo "ğŸ”Œ Tests de integraciÃ³n con tag test_build..."
      - echo "âš ï¸ AsegÃºrate de que el servicio estÃ© corriendo (task service:start)"
      - go test -tags test_build -v -run "Integration" ./...
    env:
      RUN_INTEGRATION_TESTS: '1'

  test:memory:
          desc: "ğŸ§  Test de memory leaks en polling"
          cmds:
            - echo "ğŸ§  Test de memory leaks con tag test_build..."
            - go test -tags test_build -v -run "TestNoMemoryLeakInPolling" -timeout 5m ./...

  test:resize:
    desc: "ğŸ“ Test de resize de terminal"
    cmds:
      - echo "ğŸ“ Tests de resize con tag test_build..."
      - go test -tags test_build -v -run "TestTerminalResize" ./...

  test:rotation:
    desc: "ğŸ”„ Test de rotaciÃ³n de logs"
    cmds:
      - echo "ğŸ”„ Tests de rotaciÃ³n con tag test_build..."
      - go test -tags test_build -v -run "TestLogRotation" ./...
    env:
      RUN_INTEGRATION_TESTS: '1'

  test:verbose:
    desc: "ğŸ”Š Test de toggle verbose"
    cmds:
      - echo "ğŸ”Š Tests de verbose con tag test_build..."
      - go test -tags test_build -v -run "TestVerboseToggle" ./...
    env:
      RUN_INTEGRATION_TESTS: '1'

  test:fase3:
    desc: "ğŸ“‹ Ejecutar TODOS los tests de Fase 3 (requiere servicio)"
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     FASE 3:TESTING COMPLETO           â•‘"
      - echo "â•‘     (usando tag:test_build)            â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - task: test:rotation
      - task: test:verbose
      - task: test:memory
      - task: test:resize
      - echo ""
      - echo "âœ… Fase 3 completada!"
    env:
      RUN_INTEGRATION_TESTS: '1'

  test:prod:
    desc:  "ğŸ§ª Ejecutar tests con build tag de producciÃ³n"
    cmds:
      - echo "ğŸ§ª Ejecutando tests con tag prod_build..."
      - go test -tags prod_build -v -cover ./...
    env:
      RUN_INTEGRATION_TESTS: '{{.RUN_INTEGRATION_TESTS | default "0"}}'

  bench:
    desc: "âš¡ Ejecutar benchmarks"
    cmds:
      - echo "âš¡ Benchmarks con tag test_build..."
      - go test -tags test_build -bench=. -benchmem ./...

  bench:prod:
    desc: "âš¡ Ejecutar benchmarks con tag de producciÃ³n"
    cmds:
      - echo "âš¡ Benchmarks con tag prod_build..."
      - go test -tags prod_build -bench=. -benchmem ./...

  # ===========================================================================
  # ğŸ–¥ï¸ EJECUCIÃ“N LOCAL
  # ===========================================================================
  run:installer:
    desc: "â–¶ï¸ Ejecutar el instalador TUI (modo test)"
    deps:  [build:test]
    cmds:
      - echo "â–¶ï¸ Iniciando instalador..."
      - '{{.BIN_DIR}}/{{.INSTALLER_NAME}}_test.exe'

  run:installer:prod:
    desc: "â–¶ï¸ Ejecutar el instalador TUI (modo producciÃ³n)"
    deps: [build:prod]
    cmds:
      - echo "â–¶ï¸ Iniciando instalador (PROD)..."
      - '{{.BIN_DIR}}/{{.INSTALLER_NAME}}_prod.exe'

  # ===========================================================================
  # ğŸ”§ GESTIÃ“N DEL SERVICIO (requiere Admin)
  # ===========================================================================
  service:status:
    desc: "ğŸ“Š Ver estado del servicio"
    cmds:
      - sc query {{.SERVICE_NAME}}Test 2>/dev/null || echo "Servicio no instalado"

  service:start:
    desc: "â–¶ï¸ Iniciar el servicio (requiere Admin)"
    cmds:
      - echo "â–¶ï¸ Iniciando servicio..."
      - sc start {{.SERVICE_NAME}}Test

  service:stop:
    desc: "â¹ï¸ Detener el servicio (requiere Admin)"
    cmds:
      - echo "â¹ï¸ Deteniendo servicio..."
      - sc stop {{.SERVICE_NAME}}Test

  service:restart:
    desc: "ğŸ”„ Reiniciar el servicio (requiere Admin)"
    cmds:
      - task: service:stop
      - sleep 2
      - task: service:start

  service:logs:
    desc: "ğŸ“œ Ver Ãºltimas lÃ­neas del log del servicio"
    cmds:
      - |
        LOG_PATH="$PROGRAMDATA/{{.SERVICE_NAME}}Test/{{.SERVICE_NAME}}Test.log"
        if [ -f "$LOG_PATH" ]; then
          tail -50 "$LOG_PATH"
        else
          echo "Archivo de log no encontrado: $LOG_PATH"
        fi

  service:logs:follow:
    desc: "ğŸ“œ Seguir logs en tiempo real (tail -f)"
    cmds:
      - |
        LOG_PATH="$PROGRAMDATA/{{.SERVICE_NAME}}Test/{{.SERVICE_NAME}}Test.log"
        tail -f "$LOG_PATH"

  # ===========================================================================
  # ğŸ§¹ LIMPIEZA
  # ===========================================================================
  clean:
    desc: "ğŸ§¹ Limpiar archivos compilados"
    cmds:
      - echo "ğŸ§¹ Limpiando..."
      - rm -rf {{.BIN_DIR}}
      - rm -rf embedded/bin
      - go clean -cache
      - echo "âœ… Limpieza completada"

  clean:logs:
    desc: "ğŸ§¹ Limpiar logs del servicio"
    cmds:
      - |
        LOG_PATH="$PROGRAMDATA/{{.SERVICE_NAME}}Test"
        rm -rf "$LOG_PATH"/*.log
        echo "âœ… Logs limpiados"

  # ===========================================================================
  # ğŸ“‹ CALIDAD DE CÃ“DIGO
  # ===========================================================================
  lint:
    desc: "ğŸ” Ejecutar linter (golangci-lint)"
    cmds:
      - golangci-lint run --build-tags test_build ./...

  lint:prod:
    desc: "ğŸ” Ejecutar linter con tag de producciÃ³n"
    cmds:
      - golangci-lint run --build-tags prod_build ./...

  fmt:
    desc: "âœ¨ Formatear cÃ³digo (gofmt + goimports)"
    cmds:
      - gofmt -w .
      - goimports -w .
      - echo "âœ… CÃ³digo formateado"

  vet:
    desc: "ğŸ” Ejecutar go vet"
    cmds:
      - go vet -tags test_build ./...

  vet:prod:
        desc: "ğŸ” Ejecutar go vet con tag de producciÃ³n"
        cmds:
          - go vet -tags prod_build ./...

  check:
    desc: "âœ… VerificaciÃ³n completa (fmt + vet + lint + test)"
    cmds:
      - task: fmt
      - task: vet
      - task: lint
      - task: test:unit
      - echo ""
      - echo "âœ… Todas las verificaciones pasaron!"

  check:prod:
    desc: "âœ… VerificaciÃ³n completa para producciÃ³n"
    cmds:
      - task: fmt
      - task: vet:prod
      - task: lint:prod
      - task: test:prod
      - echo ""
      - echo "âœ… Todas las verificaciones de PROD pasaron!"

  # ===========================================================================
  # ğŸ“¦ RELEASE
  # ===========================================================================
  release:
    desc: "ğŸ“¦ Crear release (limpia, verifica, compila prod)"
    cmds:
      - task: clean
      - task: check:prod
      - task: build:prod
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     ğŸ“¦ RELEASE LISTO                  â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ls -la {{.BIN_DIR}}/*_prod.exe