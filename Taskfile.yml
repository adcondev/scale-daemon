# https://taskfile.dev
# Scale Daemon - Task Runner
# Dev: AdriÃ¡n Constante @ Red2000 2026

version: '3'

silent: true

vars:
  SERVICE_NAME: R2k_BasculaServicio
  INSTALLER_NAME: R2k_BasculaInstalador

  BINARY_LOCAL: BasculaServicio_Local.exe
  BINARY_REMOTE: BasculaServicio_Remote.exe

  # Output names (R2k prefix convention)
  INSTALLER_LOCAL: R2k_Instalador_Bascula_Local.exe
  INSTALLER_REMOTE: R2k_Instalador_Bascula_Remote.exe

  # Directories
  BIN_DIR: ./bin
  EMBED_DIR: ./embedded/bin

  VERSION: '1.2.0'

env:
  CGO_ENABLED: '0'
  GOOS: windows
  GOARCH: amd64

tasks:
  default:
    desc: "ğŸ“‹ Show all available tasks"
    cmds:
      - |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           SCALE DAEMON - Task Runner v{{.VERSION}}              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸš€ QUICK START:"
        echo "   task build:local   Build LOCAL installer (localhost:8765)"
        echo "   task build:remote  Build REMOTE installer (0.0.0.0:8765)"
        echo "   task build:all     Build both installers"
        echo ""
      - task --list-all

  # ===========================================================================
  # ğŸ“¦ DEPENDENCIES
  # ===========================================================================
  deps:
    desc: "ğŸ“¦ Download and install Go dependencies"
    cmds:
      - echo "ğŸ“¦ Downloading dependencies..."
      - go mod download
      - go mod tidy
      - go mod verify
      - echo "âœ… Dependencies installed"

  # ===========================================================================
  # ğŸ—ï¸ SERVICE BUILD
  # ===========================================================================
  service:build:local:
    desc: "ğŸ”¨ Build Service for LOCAL (localhost:8765)"
    vars:
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - mkdir -p {{.EMBED_DIR}}
      - go build -ldflags "-s -w -H=windowsgui -X main.BuildEnvironment=local -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o {{.EMBED_DIR}}/{{.BINARY_LOCAL}}.exe ./cmd/BasculaServicio
      - echo "âœ… Service compiled for LOCAL (localhost:8765)"

  service:build:remote:
    desc: "ğŸ”¨ Build Service for REMOTE (0.0.0.0:8765)"
    vars:
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - mkdir -p {{.EMBED_DIR}}
      - go build -ldflags "-s -w -H=windowsgui -X main.BuildEnvironment=remote -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o {{.EMBED_DIR}}/BasculaServicio.exe ./cmd/BasculaServicio
      - echo "âœ… Service compiled for REMOTE (0.0.0.0:8765)"

  # ===========================================================================
  # ğŸ“¦ INSTALLER BUILD
  # ===========================================================================
  installer:local:
    desc: "ğŸ“¦ Build Installer with LOCAL service embedded"
    deps: [service:build:local]
    vars:
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - go build -ldflags "-s -w -X main.BuildEnvironment=local -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o {{.BIN_DIR}}/{{.INSTALLER_LOCAL}} ./cmd/BasculaInstalador
      - echo "ğŸ“¦ Created {{.BIN_DIR}}/{{.INSTALLER_LOCAL}}"

  installer:remote:
    desc: "ğŸ“¦ Build Installer with REMOTE service embedded"
    deps: [service:build:remote]
    vars:
      BUILD_DATE:
        sh: powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
      BUILD_TIME:
        sh: powershell -Command "Get-Date -Format 'HH:mm:ss'"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - go build -ldflags "-s -w -X main.BuildEnvironment=remote -X main.BuildDate={{.BUILD_DATE}} -X main.BuildTime={{.BUILD_TIME}}" -o {{.BIN_DIR}}/{{.INSTALLER_REMOTE}} ./cmd/BasculaInstalador
      - echo "ğŸ“¦ Created {{.BIN_DIR}}/{{.INSTALLER_REMOTE}}"

  # ===========================================================================
  # ğŸš€ HIGH-LEVEL BUILD COMMANDS
  # ===========================================================================
  build:local:
    desc: "ğŸ  Build everything for LOCAL environment"
    cmds:
      - task: installer:local
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘   âœ… LOCAL BUILD COMPLETE              â•‘"
      - echo "â•‘   â†’ {{.BIN_DIR}}/{{.INSTALLER_LOCAL}}  â•‘"
      - echo "â•‘   â†’ Listens on localhost:8765          â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  build:remote:
    desc: "ğŸŒ Build everything for REMOTE environment"
    cmds:
      - task: installer:remote
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘   âœ… REMOTE BUILD COMPLETE             â•‘"
      - echo "â•‘   â†’ {{.BIN_DIR}}/{{.INSTALLER_REMOTE}} â•‘"
      - echo "â•‘   â†’ Listens on 0.0.0.0:8765            â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  build:all:
    desc: "ğŸ—ï¸ Build both LOCAL and REMOTE installers"
    cmds:
      - task: build:local
      - task: build:remote
      - echo ""
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘   âœ… ALL BUILDS COMPLETE               â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ls -la {{.BIN_DIR}}/*.exe

  # ===========================================================================
  # ğŸ§ª TESTING
  # ===========================================================================
  test:
    desc: "ğŸ§ª Run all tests"
    cmds:
      - echo "ğŸ§ª Running tests..."
      - go test -v ./...

  test:unit:
    desc: "ğŸ§ª Run unit tests only (fast)"
    cmds:
      - echo "ğŸ§ª Unit tests..."
      - go test -v -short ./...

  bench:
    desc: "âš¡ Run benchmarks"
    cmds:
      - echo "âš¡ Running benchmarks..."
      - go test -bench=. -benchmem ./...

  # ===========================================================================
  # ğŸ§¹ CLEANUP
  # ===========================================================================
  clean:
    desc: "ğŸ§¹ Remove all build artifacts"
    cmds:
      - echo "ğŸ§¹ Cleaning..."
      - cmd: if exist {{.BIN_DIR}} rmdir /s /q {{.BIN_DIR}}
        ignore_error: true
      - cmd: if exist {{.EMBED_DIR}} rmdir /s /q {{.EMBED_DIR}}
        ignore_error: true
      - echo "âœ… Clean complete"