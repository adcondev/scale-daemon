<!DOCTYPE html>
<html>
<head>
    <title>Ejemplo de atributo Href</title>
</head>
<body>
<h1>Ejemplo de b√°scula</h1>
<p>
    Peso: <input id="peso" name="peso" type="text">
    Cantidad: <input id="cantidad" name="cantidad" type="text">
</p>
<p>
    Puerto COM: <input id="puerto" type="text" value="COM3"><br>
    Marca: <input id="marca" type="text" value="Rhino BAR 8RS"><br>
    Modo prueba: <input id="modoPrueba" type="checkbox">
    Direcci√≥n: <input id="direccionWs" type="text" value="ws://localhost:8765">
    <button class="btn-config" id="aplicarConfig">Aplicar Configuraci√≥n</button>
</p>

<script>
    (function () {
        const wsUrl = "ws://localhost:8765/ws";
        let socket = null;
        let reconnectDelay = 3000;
        let isConnected = false;

        function obtenerConfiguracion() {
            return {
                tipo: "config",
                puerto: document.getElementById("puerto").value || "COM3",
                marca: document.getElementById("marca").value || "Rhino BAR 8RS",
                modoPrueba: document.getElementById("modoPrueba").checked,
                dir: document.getElementById("direccionWs").value || "ws://localhost:8765/ws"
            };
        }

        function conectarWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("[‚úÖ WebSocket conectado]");
                isConnected = true;

                // Enviar configuraci√≥n al servidor
                const config = obtenerConfiguracion();
                console.log("[‚öôÔ∏è Enviando configuraci√≥n]:", config);
                socket.send(JSON.stringify(config));
            };

            socket.onmessage = (event) => {
                const peso = event.data;
                console.log("[üì¶ Peso recibido]:", peso);

                const input = document.querySelector("input[name='peso']");
                if (input) {
                    input.value = peso;
                    input.dispatchEvent(new Event("input", {bubbles: true}));
                } else {
                    console.warn("[‚ö†Ô∏è Input de peso no encontrado]");
                }
            };

            socket.onclose = () => {
                console.warn("[‚ö†Ô∏è WebSocket desconectado]");
                isConnected = false;
                reintentarConexion();
            };

            socket.onerror = (err) => {
                console.error("[‚ùå Error en WebSocket]:", err);
                socket.close();
            };
        }

        function reintentarConexion() {
            if (!isConnected) {
                setTimeout(() => {
                    console.log("[üîÅ Reintentando conexi√≥n WebSocket...]");
                    conectarWebSocket();
                }, reconnectDelay);
            }
        }

        conectarWebSocket();
    })();
</script>
</body>
</html>
