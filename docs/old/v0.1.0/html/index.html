<html>
<head>
    <title>Ejemplo de atributo Href</title>
</head>
<body>
<h1>Ejemplo de atributo Href</h1>
<p>
    Peso: <input id="peso" name="peso" type="text">
    Precio: <input id="precio" name="precio" type="text" value="100">
    Total: <input id="total" name="total" readonly type="text">
</p>
</body>

<script>
    (function () {
        const wsUrl = "ws://localhost:8765/ws";
        let socket = null;
        let reconnectDelay = 3000;
        let isConnected = false;

        function calcularTotal() {
            const pesoInput = document.querySelector("input[name='peso']");
            const precioInput = document.querySelector("input[name='precio']");
            const totalInput = document.querySelector("input[name='total']");

            const peso = parseFloat(pesoInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;

            const total = peso * precio;
            totalInput.value = total.toFixed(2);
        }

        // Cuando cambia el peso manualmente, recalcula
        document.addEventListener("DOMContentLoaded", () => {
            const pesoInput = document.querySelector("input[name='peso']");
            pesoInput.addEventListener("input", calcularTotal);
        });

        function conectarWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("[‚úÖ WebSocket conectado]");
                isConnected = true;
            };

            socket.onmessage = (event) => {
                let peso = event.data;
                let numero = parseFloat(peso.replace(/["kg]/g, "").trim());

                console.log("[üì¶ Peso recibido]:", numero, "cadena original:", peso);

                const inputPeso = document.querySelector("input[name='peso']");

                if (inputPeso) {
                    inputPeso.value = numero;
                    inputPeso.dispatchEvent(new Event("input", {bubbles: true})); // Esto activa el c√°lculo
                } else {
                    console.warn("[‚ö†Ô∏è Input de peso no encontrado]");
                }
            };

            socket.onclose = () => {
                console.warn("[‚ö†Ô∏è WebSocket desconectado]");
                isConnected = false;
                reintentarConexion();
            };

            socket.onerror = (err) => {
                console.error("[‚ùå Error en WebSocket]:", err);
                socket.close();
            };
        }

        function reintentarConexion() {
            if (!isConnected) {
                setTimeout(() => {
                    console.log("[üîÅ Reintentando conexi√≥n WebSocket...]");
                    conectarWebSocket();
                }, reconnectDelay);
            }
        }

        conectarWebSocket();
    })();
</script>
</html>
